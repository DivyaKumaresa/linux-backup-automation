#!/bin/bash

# Load configuration
source /home/ec2-user/backup.conf

TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
BACKUP_FILE="$BACKUP_DIR/backup_$TIMESTAMP.tar.gz"

echo "----------------------------------------" >> $LOG_FILE
echo "[$(date)] Backup process started" >> $LOG_FILE

# Create backup archive
tar -czf "$BACKUP_FILE" $SOURCE_DIRS 2>> $LOG_FILE

# Check backup status
if [ $? -eq 0 ]; then
    echo "[$(date)] Backup SUCCESS: $BACKUP_FILE" >> $LOG_FILE
else
    echo "[$(date)] Backup FAILED" >> $LOG_FILE
    exit 1
fi

# Apply retention policy
find "$BACKUP_DIR" -type f -mtime +$RETENTION_DAYS -delete

echo "[$(date)] Retention cleanup completed" >> $LOG_FILE
echo "[$(date)] Backup process finished" >> $LOG_FILE